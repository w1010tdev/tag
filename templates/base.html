<!DOCTYPE html>
<html lang="{{ get_locale() }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ _('Social Connect') }}{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Eruda mobile debugger -->
    <script src="//fastly.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>
    
    <!-- Socket.io MUST load before page content -->
    <script src="//fastly.jsdelivr.net/npm/socket.io-client@4.5.4/dist/socket.io.min.js" onerror="handleSocketLibraryError()"></script>
    
    <script>
        // Detect if socket.io library failed to load
        function handleSocketLibraryError() {
            const simpleStatus = document.getElementById('simple-socket-status');
            if (simpleStatus) {
                simpleStatus.style.display = 'inline-block';
                simpleStatus.textContent = '⚠️ Socket库加载失败';
                simpleStatus.style.background = '#FEE2E2';
                simpleStatus.style.color = '#991B1B';
                simpleStatus.style.borderColor = '#DC2626';
            }
            
            const statusEl = document.getElementById('socket-status');
            if (statusEl) {
                statusEl.innerHTML = 'Socket.io library failed to load. Check network connection.';
                statusEl.className = 'socket-status disconnected';
                statusEl.style.display = 'block';
            }
        }
        
        // Check if socket.io loaded successfully
        if (typeof io === 'undefined') {
            handleSocketLibraryError();
        }
        
        // Global error notification system
        function showNotification(message, type = 'error', duration = 5000) {
            const notificationEl = document.getElementById('error-notification');
            if (!notificationEl) return;
            
            // Clear any existing content
            notificationEl.innerHTML = '';
            notificationEl.className = 'error-notification ' + type;
            
            // Create notification content
            const content = document.createElement('div');
            content.className = 'error-notification-content';
            
            const icon = document.createElement('i');
            icon.className = 'error-notification-icon fas ' + 
                (type === 'error' ? 'fa-exclamation-circle' : 
                 type === 'success' ? 'fa-check-circle' : 
                 'fa-exclamation-triangle');
            
            const messageEl = document.createElement('div');
            messageEl.className = 'error-notification-message';
            messageEl.textContent = message;
            
            const closeBtn = document.createElement('button');
            closeBtn.className = 'error-notification-close';
            closeBtn.innerHTML = '<i class="fas fa-times"></i>';
            closeBtn.onclick = () => hideNotification();
            
            content.appendChild(icon);
            content.appendChild(messageEl);
            content.appendChild(closeBtn);
            notificationEl.appendChild(content);
            notificationEl.style.display = 'block';
            
            // Auto-hide after duration
            if (duration > 0) {
                setTimeout(() => hideNotification(), duration);
            }
        }
        
        function hideNotification() {
            const notificationEl = document.getElementById('error-notification');
            if (notificationEl) {
                notificationEl.style.display = 'none';
            }
        }
        
        // Socket status indicator - dual approach for Android compatibility
        function updateSocketStatus(status, message) {
            // Update fancy status indicator (may not work on all Android devices)
            const statusEl = document.getElementById('socket-status');
            if (statusEl) {
                statusEl.className = 'socket-status ' + status;
                
                if (status === 'connecting') {
                    statusEl.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ' + message;
                    statusEl.style.display = 'block';
                } else if (status === 'connected') {
                    statusEl.innerHTML = '<i class="fas fa-check-circle"></i> ' + message;
                    statusEl.style.display = 'block';
                    // Keep showing for 5 seconds instead of 2
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 5000);
                } else if (status === 'disconnected') {
                    statusEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + message;
                    statusEl.style.display = 'block';
                    // Keep showing disconnected state persistently
                }
            }
            
            // Update simple inline status (works on all devices including Android)
            const simpleStatusEl = document.getElementById('simple-socket-status');
            if (simpleStatusEl) {
                simpleStatusEl.style.display = 'inline-block';
                
                if (status === 'connecting') {
                    simpleStatusEl.textContent = '⏳ ' + message;
                    simpleStatusEl.style.background = '#FEF3C7';
                    simpleStatusEl.style.color = '#92400E';
                    simpleStatusEl.style.borderColor = '#F59E0B';
                } else if (status === 'connected') {
                    simpleStatusEl.textContent = '✓ ' + message;
                    simpleStatusEl.style.background = '#D1FAE5';
                    simpleStatusEl.style.color = '#065F46';
                    simpleStatusEl.style.borderColor = '#10B981';
                    // Keep showing for 5 seconds
                    setTimeout(() => {
                        simpleStatusEl.style.display = 'none';
                    }, 5000);
                } else if (status === 'disconnected') {
                    simpleStatusEl.textContent = '✗ ' + message;
                    simpleStatusEl.style.background = '#FEE2E2';
                    simpleStatusEl.style.color = '#991B1B';
                    simpleStatusEl.style.borderColor = '#DC2626';
                    // Keep showing disconnected state persistently
                }
            }
        }
        
        // Global socket error handler wrapper
        function handleSocketError(error, context) {
            console.error('Socket error in ' + context + ':', error);
            showNotification('{{ _('Connection error. Please check your internet connection and try again.') }}', 'error');
        }
    </script>
    
    {% block extra_css %}{% endblock %}
    <meta name="csrf-token" content="{{ csrf_token() }}">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="/" class="logo"><i class="fas fa-comments"></i> {{ _('Social Connect') }}</a>
            <div class="nav-links">
                {% if current_user.is_authenticated %}
                    <a href="{{ url_for('dashboard') }}"><i class="fas fa-home"></i> {{ _('Dashboard') }}</a>
                    <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> {{ _('Logout') }}</a>
                {% else %}
                    <a href="{{ url_for('login') }}"><i class="fas fa-sign-in-alt"></i> {{ _('Login') }}</a>
                    <a href="{{ url_for('register') }}"><i class="fas fa-user-plus"></i> {{ _('Register') }}</a>
                {% endif %}
                <!-- Simple inline socket status for Android compatibility -->
                <span id="simple-socket-status" style="display: none; margin: 0 10px; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: bold; background: #FEF3C7; color: #92400E; border: 1px solid #F59E0B;">⏳</span>
                <div class="language-selector">
                    <a href="{{ url_for('set_language', lang='en') }}" class="lang-link {% if get_locale() == 'en' %}active{% endif %}">EN</a>
                    <span class="lang-divider">|</span>
                    <a href="{{ url_for('set_language', lang='zh') }}" class="lang-link {% if get_locale() == 'zh' %}active{% endif %}">中文</a>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Error notification container -->
    <div id="error-notification" class="error-notification" style="display: none;"></div>
    
    <!-- Socket status indicator -->
    <div id="socket-status" class="socket-status" style="display: none;">
        <i class="fas fa-circle-notch fa-spin"></i> {{ _('Connecting...') }}
    </div>
    
    <main class="main-content">
        {% block content %}{% endblock %}
    </main>
    
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <p>&copy; 2024 {{ _('Social Connect') }}. {{ _('All rights reserved.') }} | v1.0.0</p>
                <div class="footer-links">
                    <a href="{{ url_for('admin_login') }}"><i class="fas fa-user-shield"></i> {{ _('Admin Portal') }}</a>
                </div>
            </div>
        </div>
    </footer>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
