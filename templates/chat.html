{% extends "base.html" %}

{% block title %}{{ _('Chat with %(username)s', username=other_user.username) }} - {{ _('Social Connect') }}{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1><i class="fas fa-comments"></i> {{ _('Chat with %(username)s', username=other_user.username) }}</h1>
        <div>
            <span id="partner-status" class="partner-status"></span>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> {{ _('Back') }}</a>
        </div>
    </div>
    
    <div class="chat-container">
        <div class="chat-messages" id="chat-messages">
            {% for msg in messages %}
            <div class="chat-message {% if msg.sender_id == current_user.id %}my-message{% else %}other-message{% endif %}" data-id="{{ msg.id }}">
                <div class="message-sender">{{ msg.sender_name }}</div>
                <div class="message-content" data-message="{{ msg.message | tojson }}">{{ msg.message | e }}</div>
                <div class="message-time">{{ msg.created_at }}</div>
            </div>
            {% endfor %}
        </div>
        
        <div class="emoji-picker" id="emoji-picker" style="display: none;">
            <div class="emoji-grid" id="emoji-grid"></div>
        </div>
        
        <div class="chat-input-container">
            <button class="emoji-toggle" id="emoji-toggle-btn" type="button" aria-label="{{ _('Toggle emoji picker') }}">
                <i class="far fa-smile"></i>
            </button>
            <input type="text" id="message-input" class="chat-input" 
                   placeholder="{{ _('Type a message...') }}" maxlength="1000" autocomplete="off">
            <button class="send-btn" id="send-btn" type="button" aria-label="{{ _('Send message') }}">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<script>
// Diagnostic: Check if socket.io is available
if (typeof io === 'undefined') {
    document.body.insertAdjacentHTML('beforeend', '<div style="position: fixed; bottom: 0; left: 0; right: 0; background: #DC2626; color: white; padding: 10px; text-align: center; z-index: 99999; font-weight: bold;">❌ Socket.io未加载 | Socket.io not loaded</div>');
}

let socket = io();

const connectionId = {{ connection.id }};
const myUserId = {{ current_user.id }};
const otherUserId = {{ other_user.id }};
const otherUsername = {{ other_user.username | tojson }};

// Configuration constants
const SOCKET_ACK_TIMEOUT = 10000; // 10 seconds

let roomJoined = false;
let isSocketConnected = false;

// Show initial connecting status
if (typeof updateSocketStatus === 'function') {
    updateSocketStatus('connecting', '{{ _('Connecting...') }}');
} else {
    // Fallback if function not defined
    const simpleStatus = document.getElementById('simple-socket-status');
    if (simpleStatus) {
        simpleStatus.style.display = 'inline-block';
        simpleStatus.textContent = '⏳ {{ _('Connecting...') }}';
    }
}

// Socket connection event handlers
socket.on('connect', function() {
    isSocketConnected = true;
    updateSocketStatus('connected', '{{ _('Connected') }}');
    
    // Track page for online status
    socket.emit('set_page', { page: 'chat', connection_id: connectionId });
    
    // Join chat room with acknowledgment
    socket.emit('join_chat', { connection_id: connectionId }, function(ack) {
        if (ack) {
            roomJoined = true;
        } else {
            showNotification('{{ _('Failed to join chat. Please refresh the page.') }}', 'error');
        }
    });
    
    // Get partner status after joining room
    socket.emit('get_user_status', { connection_id: connectionId }, function(status) {
        updatePartnerStatus(status);
    });
});

socket.on('connect_error', function(error) {
    isSocketConnected = false;
    updateSocketStatus('disconnected', '{{ _('Connection failed') }}');
    handleSocketError(error, 'chat connect');
});

socket.on('disconnect', function(reason) {
    isSocketConnected = false;
    roomJoined = false;
    updateSocketStatus('disconnected', '{{ _('Disconnected') }}');
    showNotification('{{ _('Connection lost. Attempting to reconnect...') }}', 'warning', 3000);
});

socket.on('reconnect', function(attemptNumber) {
    updateSocketStatus('connected', '{{ _('Reconnected') }}');
    showNotification('{{ _('Reconnected successfully!') }}', 'success', 2000);
});

socket.on('reconnect_attempt', function(attemptNumber) {
    updateSocketStatus('connecting', '{{ _('Reconnecting...') }} (' + attemptNumber + ')');
});

socket.on('reconnect_error', function(error) {
    handleSocketError(error, 'chat reconnect');
});

socket.on('reconnect_failed', function() {
    updateSocketStatus('disconnected', '{{ _('Connection failed') }}');
    showNotification('{{ _('Unable to reconnect. Please refresh the page.') }}', 'error', 0);
});

// Track page for online status (initial)
// Moved to connect event handler to ensure socket is connected

function updatePartnerStatus(status) {
    const statusEl = document.getElementById('partner-status');
    if (status.online) {
        if (status.page === 'chat') {
            statusEl.innerHTML = '<span class="status-online"><i class="fas fa-circle"></i> {{ _('Online') }}</span>';
        } else {
            statusEl.innerHTML = '<span class="status-away"><i class="fas fa-circle"></i> {{ _('Away') }}</span>';
        }
    } else {
        statusEl.innerHTML = '<span class="status-offline"><i class="far fa-circle"></i> {{ _('Offline') }}</span>';
    }
}

// Get partner status after socket connects (handled in connect event)
socket.on('user_status_changed', function(data) {
    if (data.user_id === otherUserId) {
        updatePartnerStatus({ online: data.online, page: data.page });
    }
});

// Send message function
function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    if (!isSocketConnected) {
        showNotification('{{ _('Not connected. Please wait for connection to be established.') }}', 'error');
        return;
    }
    
    if (!roomJoined) {
        showNotification('{{ _('Connecting... Please try again in a moment.') }}', 'warning');
        return;
    }
    
    // Disable send button temporarily
    const sendBtn = document.getElementById('send-btn');
    sendBtn.disabled = true;
    
    // Add timeout for acknowledgment
    let timeoutId = setTimeout(() => {
        sendBtn.disabled = false;
        showNotification('{{ _('Message send timeout. Please try again.') }}', 'error');
    }, SOCKET_ACK_TIMEOUT);
    
    socket.emit('send_message', {
        connection_id: connectionId,
        message: message
    }, function(ack) {
        clearTimeout(timeoutId);
        sendBtn.disabled = false;
        
        if (!ack || !ack.success) {
            const errorMsg = ack && ack.error ? ack.error : '{{ _('Message failed to send. Please try again.') }}';
            showNotification(errorMsg, 'error');
            return;
        }
        input.value = '';
        input.focus();
    });
}

// Handle enter key for message input
document.getElementById('message-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
    }
});

// Attach send button click handler
document.getElementById('send-btn').addEventListener('click', function(e) {
    e.preventDefault();
    sendMessage();
});

// Toggle emoji picker
function toggleEmojiPicker() {
    const picker = document.getElementById('emoji-picker');
    picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
}

document.getElementById('emoji-toggle-btn').addEventListener('click', function(e) {
    e.preventDefault();
    toggleEmojiPicker();
});

// Receive new messages
socket.on('new_message', function(data) {
    const messagesDiv = document.getElementById('chat-messages');
    if (document.querySelector(`.chat-message[data-id="${data.id}"]`)) {
        return;
    }
    const messageDiv = document.createElement('div');
    messageDiv.className = 'chat-message ' + (data.sender_id === myUserId ? 'my-message' : 'other-message');
    messageDiv.dataset.id = data.id;
    
    const senderDiv = document.createElement('div');
    senderDiv.className = 'message-sender';
    senderDiv.textContent = data.sender_name;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    contentDiv.innerHTML = renderMessageContent(data.message);
    
    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    timeDiv.textContent = data.created_at;
    
    messageDiv.appendChild(senderDiv);
    messageDiv.appendChild(contentDiv);
    messageDiv.appendChild(timeDiv);
    
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    // Mark as read if viewing
    if (data.sender_id !== myUserId) {
        socket.emit('mark_read', {
            connection_id: connectionId,
            message_id: data.id
        });
    }
});

const emojiIcons = [
    { token: ':fa-face-smile:', icon: 'fa-regular fa-face-smile', label: 'Smile' },
    { token: ':fa-face-smile-beam:', icon: 'fa-regular fa-face-smile-beam', label: 'Smile beam' },
    { token: ':fa-face-smile-wink:', icon: 'fa-regular fa-face-smile-wink', label: 'Wink' },
    { token: ':fa-face-laugh:', icon: 'fa-regular fa-face-laugh', label: 'Laugh' },
    { token: ':fa-face-laugh-beam:', icon: 'fa-regular fa-face-laugh-beam', label: 'Laugh beam' },
    { token: ':fa-face-laugh-squint:', icon: 'fa-regular fa-face-laugh-squint', label: 'Laugh squint' },
    { token: ':fa-face-laugh-wink:', icon: 'fa-regular fa-face-laugh-wink', label: 'Laugh wink' },
    { token: ':fa-face-grin:', icon: 'fa-regular fa-face-grin', label: 'Grin' },
    { token: ':fa-face-grin-wide:', icon: 'fa-regular fa-face-grin-wide', label: 'Wide grin' },
    { token: ':fa-face-grin-beam:', icon: 'fa-regular fa-face-grin-beam', label: 'Beam' },
    { token: ':fa-face-grin-beam-sweat:', icon: 'fa-regular fa-face-grin-beam-sweat', label: 'Relieved' },
    { token: ':fa-face-grin-stars:', icon: 'fa-regular fa-face-grin-stars', label: 'Star eyes' },
    { token: ':fa-face-grin-hearts:', icon: 'fa-regular fa-face-grin-hearts', label: 'Hearts' },
    { token: ':fa-face-grin-squint:', icon: 'fa-regular fa-face-grin-squint', label: 'Squint' },
    { token: ':fa-face-grin-squint-tears:', icon: 'fa-regular fa-face-grin-squint-tears', label: 'Laughing tears' },
    { token: ':fa-face-grin-tears:', icon: 'fa-regular fa-face-grin-tears', label: 'Grin tears' },
    { token: ':fa-face-grin-tongue:', icon: 'fa-regular fa-face-grin-tongue', label: 'Tongue' },
    { token: ':fa-face-grin-tongue-wink:', icon: 'fa-regular fa-face-grin-tongue-wink', label: 'Tongue wink' },
    { token: ':fa-face-grin-tongue-squint:', icon: 'fa-regular fa-face-grin-tongue-squint', label: 'Tongue squint' },
    { token: ':fa-face-grin-wink:', icon: 'fa-regular fa-face-grin-wink', label: 'Grin wink' },
    { token: ':fa-face-kiss:', icon: 'fa-regular fa-face-kiss', label: 'Kiss' },
    { token: ':fa-face-kiss-beam:', icon: 'fa-regular fa-face-kiss-beam', label: 'Kiss beam' },
    { token: ':fa-face-kiss-wink-heart:', icon: 'fa-regular fa-face-kiss-wink-heart', label: 'Kiss heart' },
    { token: ':fa-face-surprise:', icon: 'fa-regular fa-face-surprise', label: 'Surprise' },
    { token: ':fa-face-flushed:', icon: 'fa-regular fa-face-flushed', label: 'Flushed' },
    { token: ':fa-face-meh:', icon: 'fa-regular fa-face-meh', label: 'Meh' },
    { token: ':fa-face-meh-blank:', icon: 'fa-regular fa-face-meh-blank', label: 'Blank' },
    { token: ':fa-face-rolling-eyes:', icon: 'fa-regular fa-face-rolling-eyes', label: 'Eye roll' },
    { token: ':fa-face-frown:', icon: 'fa-regular fa-face-frown', label: 'Frown' },
    { token: ':fa-face-frown-open:', icon: 'fa-regular fa-face-frown-open', label: 'Open frown' },
    { token: ':fa-face-sad-tear:', icon: 'fa-regular fa-face-sad-tear', label: 'Sad' },
    { token: ':fa-face-sad-cry:', icon: 'fa-regular fa-face-sad-cry', label: 'Crying' },
    { token: ':fa-face-tired:', icon: 'fa-regular fa-face-tired', label: 'Tired' },
    { token: ':fa-face-dizzy:', icon: 'fa-regular fa-face-dizzy', label: 'Dizzy' },
    { token: ':fa-face-angry:', icon: 'fa-regular fa-face-angry', label: 'Angry' },
    { token: ':fa-face-grimace:', icon: 'fa-regular fa-face-grimace', label: 'Grimace' },
    { token: ':fa-heart:', icon: 'fa-solid fa-heart', label: 'Heart' },
    { token: ':fa-heart-crack:', icon: 'fa-solid fa-heart-crack', label: 'Broken heart' },
    { token: ':fa-heart-circle-plus:', icon: 'fa-solid fa-heart-circle-plus', label: 'Heart plus' },
    { token: ':fa-heart-circle-check:', icon: 'fa-solid fa-heart-circle-check', label: 'Heart check' },
    { token: ':fa-thumbs-up:', icon: 'fa-solid fa-thumbs-up', label: 'Thumbs up' },
    { token: ':fa-thumbs-down:', icon: 'fa-solid fa-thumbs-down', label: 'Thumbs down' },
    { token: ':fa-hands-clapping:', icon: 'fa-solid fa-hands-clapping', label: 'Clap' },
    { token: ':fa-hands-praying:', icon: 'fa-solid fa-hands-praying', label: 'Pray' },
    { token: ':fa-handshake:', icon: 'fa-solid fa-handshake', label: 'Handshake' },
    { token: ':fa-star:', icon: 'fa-solid fa-star', label: 'Star' },
    { token: ':fa-fire:', icon: 'fa-solid fa-fire', label: 'Fire' },
    { token: ':fa-bolt:', icon: 'fa-solid fa-bolt', label: 'Bolt' },
    { token: ':fa-gift:', icon: 'fa-solid fa-gift', label: 'Gift' },
    { token: ':fa-bell:', icon: 'fa-solid fa-bell', label: 'Bell' },
    { token: ':fa-comments:', icon: 'fa-solid fa-comments', label: 'Chat' },
    { token: ':fa-rocket:', icon: 'fa-solid fa-rocket', label: 'Rocket' },
    { token: ':fa-cake-candles:', icon: 'fa-solid fa-cake-candles', label: 'Cake' },
    { token: ':fa-music:', icon: 'fa-solid fa-music', label: 'Music' },
    { token: ':fa-sun:', icon: 'fa-solid fa-sun', label: 'Sun' },
    { token: ':fa-moon:', icon: 'fa-solid fa-moon', label: 'Moon' },
    { token: ':fa-wand-magic-sparkles:', icon: 'fa-solid fa-wand-magic-sparkles', label: 'Sparkles' }
];

const allowedIconClasses = new Set(
    emojiIcons.flatMap(item => item.icon.split(' '))
);

const emojiMap = emojiIcons.reduce((map, item) => {
    const className = item.icon
        .split(' ')
        .filter(cls => allowedIconClasses.has(cls))
        .join(' ');
    const safeLabel = item.label.replace(/[^a-z0-9\s-]/gi, '');
    map[item.token] = `<i class="${className} fa-emoji-icon" aria-label="${safeLabel}"></i>`;
    return map;
}, {});

const emojiGrid = document.getElementById('emoji-grid');
emojiIcons.forEach(item => {
    const button = document.createElement('button');
    button.type = 'button';
    button.className = 'emoji-btn';
    button.dataset.token = item.token;
    button.innerHTML = `<i class="${item.icon}" aria-hidden="true"></i>`;
    button.addEventListener('click', () => {
        insertAtCursor(document.getElementById('message-input'), item.token);
        toggleEmojiPicker();
    });
    emojiGrid.appendChild(button);
});

function insertAtCursor(input, text) {
    const start = input.selectionStart;
    const end = input.selectionEnd;
    input.value = input.value.slice(0, start) + text + input.value.slice(end);
    const newPosition = start + text.length;
    input.setSelectionRange(newPosition, newPosition);
    input.focus();
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function renderMessageContent(text) {
    const escaped = escapeHtml(text);
    return escaped.replace(/:fa-[a-z0-9-]+:/g, match => emojiMap[match] || match);
}

document.querySelectorAll('.message-content').forEach((element) => {
    let rawMessage = element.textContent;
    if (element.dataset.message) {
        try {
            rawMessage = JSON.parse(element.dataset.message);
        } catch (error) {
            rawMessage = element.textContent;
        }
    }
    const safeMessage = typeof rawMessage === 'string' ? rawMessage : '';
    element.innerHTML = renderMessageContent(safeMessage);
});

// Scroll to bottom on load
document.getElementById('chat-messages').scrollTop = 
    document.getElementById('chat-messages').scrollHeight;
</script>
{% endblock %}
