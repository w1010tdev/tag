{% extends "base.html" %}

{% block title %}{{ _('Dashboard') }} - {{ _('Social Connect') }}{% endblock %}

{% block content %}
<div class="container dashboard">
    <h1>{{ _('Welcome, %(username)s!', username=current_user.username) }}</h1>
    
    <div class="dashboard-section">
        <h2>{{ _('Your Invite Token') }}</h2>
        <div class="token-card">
            <p>{{ _('Share this link with others to connect:') }}</p>
            <div class="token-display">
                <input type="text" id="invite-link" readonly 
                       value="{{ request.url_root }}connect/{{ user_token }}">
                <button onclick="copyToken()" class="btn btn-secondary">{{ _('Copy') }}</button>
            </div>
            <button onclick="refreshToken()" class="btn btn-warning">{{ _('Refresh Token') }}</button>
            <p class="token-note"><i class="fas fa-circle-exclamation"></i> {{ _('Token is one-time use and will be invalidated after someone uses it') }}</p>
        </div>
    </div>
    
    <div class="dashboard-section">
        <h2>{{ _('Your Connections') }}</h2>
        {% if connections %}
        <div class="connections-grid">
            {% for connection in connections %}
            <div class="connection-card">
                <h3>{{ connection.other_username }}</h3>
                <p class="connection-date">{{ _('Connected:') }} {{ connection.created_at }}</p>
                <div class="connection-actions">
                    <a href="{{ url_for('chat', connection_id=connection.id) }}" 
                       class="btn btn-primary btn-sm">
                       <i class="fas fa-comments"></i> {{ _('Chat') }}
                       {% if connection.unread_chat > 0 %}
                       <span class="badge">{{ connection.unread_chat }}</span>
                       {% endif %}
                    </a>
                    <a href="{{ url_for('clipboard', connection_id=connection.id) }}" 
                       class="btn btn-primary btn-sm">
                       <i class="fas fa-clipboard"></i> {{ _('Clipboard') }}
                       {% if connection.unread_clipboard %}
                       <span class="badge">!</span>
                       {% endif %}
                    </a>
                    <a href="{{ url_for('drawing_game', connection_id=connection.id) }}" 
                       class="btn btn-secondary btn-sm">
                       <i class="fas fa-palette"></i> {{ _('Drawing') }}
                       {% if connection.unread_drawing %}
                       <span class="badge">!</span>
                       {% endif %}
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="empty-state">{{ _('No connections yet. Share your invite token to connect with others!') }}</p>
        {% endif %}
    </div>
</div>

<script>
function copyToken() {
    const input = document.getElementById('invite-link');
    
    // Modern Clipboard API
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(input.value).then(() => {
            alert('{{ _('Link copied to clipboard!') }}');
        }).catch(() => {
            // Fallback for older browsers
            input.select();
            document.execCommand('copy');
            alert('{{ _('Link copied to clipboard!') }}');
        });
    } else {
        // Fallback for older browsers
        input.select();
        document.execCommand('copy');
        alert('{{ _('Link copied to clipboard!') }}');
    }
}

function refreshToken() {
    if (confirm('{{ _('Are you sure? Your current token will be invalidated.') }}')) {
        // Get CSRF token from meta tag
        const csrfTokenElement = document.querySelector('meta[name="csrf-token"]');
        if (!csrfTokenElement) {
            alert('{{ _('Error: CSRF token not found') }}');
            return;
        }
        const csrfToken = csrfTokenElement.getAttribute('content');
        
        fetch('{{ url_for("refresh_token") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('{{ _('Failed to refresh token') }}');
            }
            location.reload();
        })
        .catch(error => {
            alert('{{ _('Error:') }} ' + error.message);
        });
    }
}
</script>
{% endblock %}
