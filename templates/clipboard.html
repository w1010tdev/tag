{% extends "base.html" %}

{% block title %}{{ _('Shared Clipboard') }} - {{ _('Social Connect') }}{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1><i class="fas fa-clipboard"></i> {{ _('Shared Clipboard with %(username)s', username=other_user.username) }}</h1>
        <div>
            <span id="partner-status" class="partner-status"></span>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> {{ _('Back') }}</a>
        </div>
    </div>
    
    <div class="clipboard-container">
        <div class="clipboard-pane">
            <h3><i class="fas fa-user"></i> {{ _('Your Area (%(username)s)', username=current_user.username) }}</h3>
            <textarea id="my-clipboard" class="clipboard-textarea" 
                      placeholder="{{ _('Type here... Changes sync in real-time') }}"></textarea>
        </div>
        <div class="clipboard-pane">
            <h3><i class="fas fa-user-friends"></i> {{ _("%(username)s's Area", username=other_user.username) }}</h3>
            <textarea id="other-clipboard" class="clipboard-textarea" 
                      placeholder="{{ _('Waiting for %(username)s to type...', username=other_user.username) }}" readonly></textarea>
        </div>
    </div>
</div>

<script>
const socket = io();
const connectionId = {{ connection.id }};
const myUserId = {{ current_user.id }};
const otherUserId = {{ other_user.id }};
const otherUsername = {{ other_user.username | tojson }};

let roomJoined = false;
let isSocketConnected = false;

// Socket connection event handlers
socket.on('connect', function() {
    isSocketConnected = true;
    updateSocketStatus('connected', '{{ _('Connected') }}');
    
    // Track page for online status
    socket.emit('set_page', { page: 'clipboard', connection_id: connectionId });
    
    // Join clipboard room with acknowledgment
    socket.emit('join_clipboard', { connection_id: connectionId }, function(ack) {
        if (ack) {
            roomJoined = true;
        } else {
            showNotification('{{ _('Failed to join clipboard. Please refresh the page.') }}', 'error');
        }
    });
});

socket.on('connect_error', function(error) {
    isSocketConnected = false;
    updateSocketStatus('disconnected', '{{ _('Connection failed') }}');
    handleSocketError(error, 'clipboard connect');
});

socket.on('disconnect', function(reason) {
    isSocketConnected = false;
    roomJoined = false;
    updateSocketStatus('disconnected', '{{ _('Disconnected') }}');
    showNotification('{{ _('Connection lost. Changes may not sync until reconnected.') }}', 'warning', 3000);
});

socket.on('reconnect', function(attemptNumber) {
    updateSocketStatus('connected', '{{ _('Reconnected') }}');
    showNotification('{{ _('Reconnected successfully!') }}', 'success', 2000);
});

socket.on('reconnect_attempt', function(attemptNumber) {
    updateSocketStatus('connecting', '{{ _('Reconnecting...') }} (' + attemptNumber + ')');
});

socket.on('reconnect_error', function(error) {
    handleSocketError(error, 'clipboard reconnect');
});

socket.on('reconnect_failed', function() {
    updateSocketStatus('disconnected', '{{ _('Connection failed') }}');
    showNotification('{{ _('Unable to reconnect. Please refresh the page.') }}', 'error', 0);
});

// Track page for online status (initial)
socket.emit('set_page', { page: 'clipboard', connection_id: connectionId });

// Get partner status
socket.emit('get_user_status', { connection_id: connectionId }, function(status) {
    updatePartnerStatus(status);
});

socket.on('user_status_changed', function(data) {
    if (data.user_id === otherUserId) {
        updatePartnerStatus({ online: data.online, page: data.page });
    }
});

function updatePartnerStatus(status) {
    const statusEl = document.getElementById('partner-status');
    if (status.online) {
        if (status.page === 'clipboard') {
            statusEl.innerHTML = '<span class="status-online"><i class="fas fa-circle"></i> {{ _('Online') }}</span>';
        } else {
            statusEl.innerHTML = '<span class="status-away"><i class="fas fa-circle"></i> {{ _('Away') }}</span>';
        }
    } else {
        statusEl.innerHTML = '<span class="status-offline"><i class="far fa-circle"></i> {{ _('Offline') }}</span>';
    }
}

// Join clipboard room with acknowledgment
socket.emit('join_clipboard', { connection_id: connectionId }, function(ack) {
    if (ack) {
        roomJoined = true;
    } else {
        showNotification('{{ _('Failed to join clipboard. Please refresh the page.') }}', 'error');
    }
});

// Re-join on reconnect (handled in socket.on('connect') above)
// Removed duplicate code

// Load existing content
{% if clipboard_data %}
    {% if current_user.id in clipboard_data %}
    document.getElementById('my-clipboard').value = {{ clipboard_data[current_user.id].content|tojson }};
    {% endif %}
    {% if other_user.id in clipboard_data %}
    document.getElementById('other-clipboard').value = {{ clipboard_data[other_user.id].content|tojson }};
    {% endif %}
{% endif %}

const myClipboard = document.getElementById('my-clipboard');
const otherClipboard = document.getElementById('other-clipboard');
let lastLocalClipboard = myClipboard.value;

function shouldUpdateLocalClipboard(content) {
    return document.activeElement !== myClipboard && content !== lastLocalClipboard;
}

// Send updates
let timeout;
myClipboard.addEventListener('input', function(e) {
    clearTimeout(timeout);
    lastLocalClipboard = e.target.value;
    timeout = setTimeout(() => {
        if (!isSocketConnected) {
            showNotification('{{ _('Not connected. Changes will sync when connection is restored.') }}', 'warning', 3000);
            return;
        }
        if (roomJoined) {
            socket.emit('clipboard_update', {
                connection_id: connectionId,
                content: e.target.value
            });
        }
    }, 500);
});

// Receive updates
socket.on('clipboard_sync', function(data) {
    if (data.user_id === myUserId) {
        if (shouldUpdateLocalClipboard(data.content)) {
            myClipboard.value = data.content;
        }
        return;
    }
    if (data.content !== otherClipboard.value) {
        otherClipboard.value = data.content;
    }
});
</script>
{% endblock %}
